#!/usr/bin/env python

import os
import json
import gspread
from oauth2client.client import SignedJwtAssertionCredentials
import PBridge
import sys
import syslog

print('Starting Up, please wait for promnt...')
# For Testing purposes
#scan = ''

exec_path = os.path.dirname(os.path.realpath(__file__))
# Configuration
json_key = json.load(open("%s/inventory-06b3cba18fd9.json" % exec_path))
syslog.openlog('Inventor')

# Variables (Do Not Edit!)
scope = ['https://spreadsheets.google.com/feeds']
creds = SignedJwtAssertionCredentials(
    json_key['client_email'], json_key['private_key'].encode(), scope)
gc = gspread.authorize(creds)
wks = gc.open("Zenefits Inventory")


def normal_reduction(barcode, wks):
    # Reduces QTY by 1
    Qty_to_update = -(int('1'))
    try:
        cell = wks.find(barcode)
        cellRow = int(cell.row)
        cellCol = int(cell.col)
        values_list = wks.row_values(cellRow)
        cellCol = cellCol + 1
        current_Qty = int(values_list[1]) + Qty_to_update
        wks.update_cell(cellRow, cellCol, current_Qty)
        print('Item successfully reduced by ' + str(-Qty_to_update))
        confirmation("Reduced", barcode, str(-Qty_to_update))
    except Exception:
        print('Barcode not found!')

def add_inventory(wks):
    # Adds Inventory
    text = "*(Add Mode)*"
    barcode = barcode_scan(text)
    try:
        cell = wks.find(barcode)
        print('Please Enter QTY.')
        Qty_to_update = (int(qty_Enter("Increasing", barcode)))
        cellRow = int(cell.row)
        cellCol = int(cell.col)
        values_list = wks.row_values(cellRow)
        cellCol = cellCol + 1
        current_Qty = int(values_list[1]) + Qty_to_update
        wks.update_cell(cellRow, cellCol, current_Qty)
        print('Item successfully increased by ' + str(Qty_to_update))
        confirmation("Increased", barcode, str(Qty_to_update))
    except Exception:
        print('Barcode not found! Resetting...')

def subtract_inventory(wks):
    # Subtracts Inventory
    text = "*(Subtract Mode)*"
    barcode = barcode_scan(text)
    try:
        cell = wks.find(barcode)
        Qty_to_update = -(int(qty_Enter("Reducing", barcode)))
        print(Qty_to_update)
        cellRow = int(cell.row)
        cellCol = int(cell.col)
        values_list = wks.row_values(cellRow)
        cellCol = cellCol + 1
        current_Qty = int(values_list[1]) + Qty_to_update
        wks.update_cell(cellRow, cellCol, current_Qty)
        print('Item successfully reduced by ' + str(-Qty_to_update))
        confirmation("Reduced", barcode, str(-Qty_to_update))
    except Exception:
        print('Barcode not found! Resetting...')

def audit_inventory(wks):
    # Audits Inventory
    # TODO pashua screen for audit
    for i in range(2,10):
        values_list = wks.row_values(i)
        if values_list[0] != '':    
            barcode = values_list[0]
            cell = wks.find(barcode)
            cellRow = int(cell.row)
            cellCol = int(cell.col)
            cellCol = cellCol + 1
            current_item = str(values_list[0])
            reported_stock = str(values_list[1])
            Qty_to_update = audit(current_item, reported_stock)
            print(Qty_to_update)
            current_Qty = Qty_to_update
            wks.update_cell(cellRow, cellCol, current_Qty)
            confirmation_audit(current_item, str(int(reported_stock) - int(current_Qty)), str(current_Qty))
    audit_complete()

def location_get():
    location_view = """
    *.title = Inventor - Location
    text.type = text
    text.default = Please Scan Location
    text.height = 50
    text.width = 256
    loc.type = textfield
    loc.label =
    cb.type = cancelbutton
    """
    result = PBridge.run(location_view)
    if result['cb'] == "1":
        logger("User Canceled")
        sys.exit(0)
    return result['loc']

def barcode_scan(text):
    #
    barcode_view = """
    *.title = Inventor - Inventory Update
    text.type = text
    """
    barcode_view += "\ntext.default = %s[return]Please Scan Barcode\n" % text
    barcode_view += """
    text.height = 50
    text.width = 256
    barcode.type = textfield
    barcode.label = 
    barcode.width = 256
    cb.type = cancelbutton

    """
    result = PBridge.run(barcode_view)
    if result["cb"] == "1":
        logger("User Canceled")
        sys.exit(0)
    return result['barcode']

def qty_Enter(function, text):
    qty_view = """ 
    *.title = Inventor - Inventory Update
    txt.type = text
    """
    qty_view += "\ntxt.default = Enter Qty for %s %s" % (function, text)
    qty_view += """

    txt.height = 50
    txt.width = 256
    qty.type = textfield
    qty.label =
    qty.width = 256
    cb.type = cancelbutton

    """
    result = PBridge.run(qty_view)
    print(result)
    if result["cb"] == "1":
        logger("User Canceled")
        sys.exit(0)
    return result['qty']

def confirmation(fuction, barcode, text):
    confirm_view = """
    *.title = Invetor - Confirmation
    txt.type = text
    txt.height = 50
    txt.width = 256
    """
    confirm_view += "\ntxt.default = %s %s by %s" % (barcode, fuction, text)

    confirm_view += """

    """
    result = PBridge.run(confirm_view)
    # if result["cb"] == "1":
    #     logger("User Canceled")
    #     sys.exit(0)

def confirmation_audit(item, devation, qty):
    confirm_view = """
    *.title = Invetor - Confirmation
    txt.type = text
    txt.height = 50
    txt.width = 256
    """
    confirm_view += "\ntxt.default = Stock devation for %s is %s[return]Stock now set at %s" % (item, devation, qty)

    confirm_view += """

    """
    result = PBridge.run(confirm_view)
    # if result["cb"] == "1":
    #     logger("User Canceled")
    #     sys.exit(0)

def audit_complete():
    confirm_view = """
    *.title = Invetor - Confirmation
    txt.type = text
    txt.height = 50
    txt.width = 256
    txt.default = Audit Mode Complete!

    """
    result = PBridge.run(confirm_view)
    # if result["cb"] == "1":
    #     logger("User Canceled")
    #     sys.exit(0)

def audit(item, qty):
    audit_view = """
    *.title = Inventor - Audit Mode
    txt.type = text
    """
    audit_view += "txt.default = *(Audit Mode)*[return]Reported Stock of %s is %s[return]Please enter Current Stock" % (item, qty)
    audit_view += """
    txt.height = 50
    txt.height = 256
    audit.type = textfield
    audit.label =
    audit.width = 256
    cb.type = cancelbutton
    """
    result = PBridge.run(audit_view)
    if result['cb'] == "1":
        return sys.exit(0)
    return result['audit']

def main_loop():
    while True:
        print('Please Scan barcode:')
        text = ""
        scan = barcode_scan(text)

        if scan == 'Add':
            add_inventory(current_wks)
        elif scan == 'Subtract':
            subtract_inventory(current_wks)
        elif scan == 'Audit':
            audit_inventory(current_wks)
        else:
            normal_reduction(scan, current_wks)

def logger(message):
    syslog.syslog(syslog.LOG_ALERT, message)

# Set Sheet Location
location = location_get()
current_wks = wks.worksheet(location)

if __name__ == "__main__":
    logger("Starting Inventor")
    main_loop()
    logger("Inventor has exited")
